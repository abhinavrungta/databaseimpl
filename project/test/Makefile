# A Makefile for fusing Google Test and building a sample test against it.
#
# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make check  - makes everything and runs the built sample test.
#   make clean  - removes all files generated by make.

# Points to the root of fused Google Test, relative to where this file is.
FUSED_GTEST_DIR = ..

# Paths to the fused gtest files.
FUSED_GTEST_H = $(FUSED_GTEST_DIR)/gtest/gtest.h
FUSED_GTEST_ALL_CC = $(FUSED_GTEST_DIR)/gtest/gtest-all.cc

# Where to find the sample test.
SRC_DIR = ../src

# Where to find gtest_main.cc.
GTEST_MAIN_CC = $(FUSED_GTEST_DIR)/gtest/gtest_main.cc

# Flags passed to the preprocessor.
# We have no idea here whether pthreads is available in the system, so
# disable its use.
CPPFLAGS += -I$(FUSED_GTEST_DIR) -DGTEST_HAS_PTHREAD=0

# Flags passed to the C++ compiler.
CXXFLAGS += -g

all : test

check : all
	./test

clean :
	rm -rf test *.o

gtest-all.o : $(FUSED_GTEST_H) $(FUSED_GTEST_ALL_CC)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(FUSED_GTEST_DIR)/gtest/gtest-all.cc

gtest_main.o : $(FUSED_GTEST_H) $(GTEST_MAIN_CC)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(GTEST_MAIN_CC)

SOURCES=TwoWayList.cc sample1.cc
TESTS=sample1_unittest.cc
OBJECTS=$(SOURCES:.cc=.o)
OBJECTS_TESTS=$(TESTS:.cc=.o)

src.o :
	for dir in $(SOURCES); do \
		$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(SRC_DIR)/$$dir; \
	done

unittest.o :
	for dir in $(TESTS); do \
		$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $$dir; \
	done

test : src.o unittest.o gtest-all.o gtest_main.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(OBJECTS) $(OBJECTS_TESTS) gtest-all.o gtest_main.o -o $@
